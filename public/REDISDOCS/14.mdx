# Безопасность Redis: От "Доверяй Всем" до ACL и Сетевой Изоляции

## Введение: Болезни Роста

Исторически Redis создавался с прицелом на максимальную производительность и работу во внутренних, доверенных сетях. Предполагалось, что защита доступа к Redis — это задача сетевой инфраструктуры (фаерволов, приватных сетей), а не самого Redis. Первые версии имели минимум встроенных средств безопасности, что привело к репутации (частично заслуженной) "небезопасного" инструмента, если его случайно или намеренно выставить в недоверенную среду.

С ростом популярности Redis и его использованием в более сложных и распределенных системах требования к безопасности возросли. Появление Access Control Lists (ACL) в Redis 6 стало огромным шагом вперед. Но являются ли ACL панацеей? И какую роль играет сетевая безопасность? Давайте разберемся критически.

## Исторический Контекст: requirepass и Доверенные Сети

**Философия**: Скорость > Безопасность. Redis должен быть быстрым, защита — дело окружения.

**Единственная Защита**: Директива `requirepass` в redis.conf, позволяющая установить один пароль для аутентификации клиентов (`AUTH password`).

### Проблемы requirepass:

- **Один пароль на всех**: Нет возможности разделить права доступа между разными клиентами или приложениями.
- **Передача пароля**: Без TLS пароль передается по сети в открытом виде.
- **Подбор**: Простые пароли легко подбираются.

**Критический Взгляд**: Модель `requirepass` была адекватна только для базовой защиты от случайного подключения в полностью доверенной сети. Она совершенно недостаточна для современных требований безопасности.

## Redis 6+: Access Control Lists (ACL) – Гранулярный Контроль

Появление ACL в Redis 6 кардинально изменило ситуацию. Это полноценная система авторизации.

**Суть**: Позволяет создавать именованных пользователей, назначать им пароли и детально настраивать права доступа к командам и ключам.

### Основные Компоненты:

- **Пользователи**: Определяются через `ACL SETUSER <username> [правила...]`. Есть встроенный пользователь default.

- **Аутентификация**: Пароли (включая хешированные SHA256 через `>` или `#`), возможность отключить пароль (`nopass`) или пользователя (`off`).

- **Правила Команд**: Очень гибкая система:
  - **Разрешение (+)**: `+GET`, `+SET`, `+@read` (все команды чтения), `+@write`, `+@admin`, `+@all`.
  - **Запрет (-)**: `-KEYS`, `-FLUSHALL`, `-@dangerous`.
  - **Комбинации**: `+@all -@dangerous -KEYS` (все, кроме опасных и KEYS).

- **Правила Ключей**: Ограничение доступа к ключам по шаблону (glob-style): `~some:prefix:*` (только ключи с этим префиксом), `~*` (все ключи).

- **Селекторы Команд** (Redis 7+): Еще более тонкая настройка, например, разрешить только чтение определенных полей в HASH (`+HGET|field1`).

**Пример Строки ACL**:
```
ACL SETUSER webapp ON >securepassword ~products:* +@read +HSET +LPUSH -@dangerous
```
(Пользователь 'webapp', включен, пароль 'securepassword', доступ только к ключам products:*, разрешены все команды чтения + HSET и LPUSH, запрещены опасные команды).

### Преимущества ACL:

- **Гранулярность**: Реализация принципа наименьших привилегий. Каждому приложению — только необходимые права.
- **Безопасность**: Множество пользователей, разные пароли (в т.ч. хешированные).
- **Гибкость**: Комбинация правил для команд и ключей позволяет настроить доступ очень точно.

---

## Критические Соображения по ACL

- **Сложность Управления**: Настройка и аудит сложных ACL для множества пользователей может стать нетривиальной задачей. Встроенной ролевой модели нет (хотя ее можно эмулировать).
- **Небольшой Оверхед**: Проверка ACL перед выполнением каждой команды добавляет минимальную задержку.
- **ACL — это Авторизация, не Защита Сети**: ACL определяют, что может делать уже подключившийся пользователь. Они не защищают от попыток подключения, DDoS, эксплуатации уязвимостей самого Redis или ОС.

## Неотъемлемая Часть: Сетевая Безопасность

Даже с самыми строгими ACL, безопасность Redis начинается на сетевом уровне.

### Директива bind: КРИТИЧЕСКИ ВАЖНО!

Эта настройка определяет, на каких сетевых интерфейсах Redis принимает соединения.

- `bind 127.0.0.1 ::1` (часто по умолчанию): Принимать соединения только с localhost (IPv4 и IPv6). Самый безопасный вариант.
- `bind <внутренний_IP_сервера> 127.0.0.1 ::1`: Принимать соединения с localhost и с указанного внутреннего IP.
- `bind 0.0.0.0` или `bind *`: **ОПАСНО!** Принимать соединения со всех сетевых интерфейсов. Никогда не используйте это без очень строгого фаервола!

### Другие аспекты сетевой безопасности:

- **Фаервол**: Всегда настраивайте фаервол (iptables, ufw, облачный security group) так, чтобы доступ к порту Redis (по умолчанию 6379) был разрешен только с IP-адресов ваших серверов приложений или других доверенных хостов.

- **Защищенный режим** (`protected-mode yes`): Включен по умолчанию в современных версиях. Если Redis настроен на прием соединений не только с localhost (`bind` не только 127.0.0.1) И при этом не настроена аутентификация (нет `requirepass` и нет паролей у default пользователя ACL), то Redis будет отвечать только клиентам с localhost, а внешним будет выдавать ошибку. Это защита от случайного выставления незащищенного Redis в сеть. Не отключайте его, если не понимаете на 100%, что делаете!

- **TLS/SSL** (с Redis 6+): Возможность шифровать трафик между клиентом и сервером. Необходимо, если данные передаются по недоверенной сети. Добавляет вычислительный оверхед.

---

## Критический Взгляд на Общую Безопасность Redis

### Эволюция

Redis прошел путь от почти полного отсутствия встроенной безопасности к современной гранулярной системе ACL. Говорить, что Redis "небезопасен по своей природе", сегодня уже некорректно.

### Многоуровневая Защита

Безопасность Redis — это система:

1. **Уровень 1 (Самый важный)**: Сетевая Изоляция (`bind` + фаервол). Не допускайте неавторизованный сетевой доступ.
2. **Уровень 2**: Аутентификация (ACL с паролями или `requirepass`). Убедитесь, что подключиться могут только легитимные клиенты.
3. **Уровень 3**: Авторизация (ACL). Ограничьте права аутентифицированных клиентов до минимума необходимого.
4. **Уровень 4 (Опционально)**: Шифрование (TLS). Защитите данные при передаче по сети.

### Распространенные Ошибки

Полагаться только на `requirepass` без фаервола; биндить Redis на 0.0.0.0; отключать protected-mode; использовать простые пароли; давать всем клиентам полные права (`+@all ~*`).

## Итог

Современный Redis (6+) с ACL предоставляет мощные инструменты для гранулярной авторизации. Однако безопасность Redis — это комплексная задача, где правильная сетевая конфигурация (`bind`, фаервол) является первым и абсолютно необходимым рубежом обороны.

ACL эффективно работают только в сочетании с надежной сетевой изоляцией. Нельзя пренебрегать ни одним из уровней защиты.
