# Тема #13: Middleware (Промежуточное ПО) в Express

## 1. Что такое Middleware?

- **Функции-Обработчики**: Middleware в Express — это просто функции JavaScript, которые имеют доступ к:
  - Объекту запроса (`req`).
  - Объекту ответа (`res`).
  - Следующей функции middleware в цепочке (`next`).
- **Сигнатура**: Обычно `(req, res, next) => { ... }`. (У middleware для обработки ошибок — 4 аргумента, см. ниже).
- **Цепочка Выполнения (Pipeline)**: Express-приложение можно представить как конвейер или цепочку из middleware-функций. Когда приходит запрос, он последовательно проходит через эти функции в том порядке, в котором они были зарегистрированы.

## 2. Что Может Делать Middleware?

Каждая функция middleware может:

- **Выполнять любой код**: Логировать, проверять заголовки, обращаться к базе данных и т.д.
- **Изменять объекты req и res**: Например, парсить тело запроса и добавлять его в `req.body`, добавлять информацию о пользователе в `req.user`, устанавливать заголовки ответа в `res`.
- **Завершить цикл запрос-ответ**: Отправить ответ клиенту с помощью `res.send()`, `res.json()`, `res.end()` и т.д. Если middleware отправляет ответ, следующие middleware и обработчики маршрута вызваны не будут.
- **Передать управление следующей функции middleware**: Вызвать функцию `next()`. Если middleware не завершает ответ и не вызывает `next()`, запрос "зависнет"!

## 3. Как Регистрируется Middleware?

- **app.use([path], middlewareFunc)**: Самый распространенный способ.
  - **Без path**: Middleware применяется ко всем запросам, приходящим на сервер, независимо от пути и метода.
  - **С path**: Middleware применяется только к запросам, путь которых начинается с указанного path.
  - Может принимать несколько middleware: `app.use(mw1, mw2)`.
  - Может монтировать express.Router: `app.use('/api/users', userRouter)`.
- **app.METHOD(path, [middleware1, ...], finalHandler)**: Middleware указывается перед финальным обработчиком маршрута. Они выполнятся только для запросов, соответствующих методу и пути.

## 4. Порядок Middleware – КРИТИЧЕСКИ ВАЖЕН!

Middleware выполняется строго последовательно. Порядок их регистрации через `app.use()` или `app.METHOD()` имеет огромное значение.

**Пример**: Middleware для парсинга JSON (`express.json()`) должно быть зарегистрировано ДО маршрутов, которые пытаются читать `req.body`. Middleware для аутентификации должно идти ДО защищенных маршрутов.

```javascript
const express = require('express');
const app = express();

// 1. Middleware для логирования - выполнится для всех запросов первым
app.use((req, res, next) => {
  console.log('Time:', Date.now(), '| Method:', req.method, '| Path:', req.originalUrl);
  next(); // Передаем управление дальше
});

// 2. Middleware для парсинга JSON-тела - ДО обработчиков, которым нужен req.body
app.use(express.json());

// 3. Маршрут, использующий req.body
app.post('/items', (req, res) => {
  console.log('Received body:', req.body); // Работает, т.к. express.json() отработал раньше
  if (!req.body || !req.body.name) {
     return res.status(400).json({ error: 'Item name is required' });
  }
  // ... логика добавления item ...
  res.status(201).json({ message: 'Item added', item: req.body });
});

// 4. Другие маршруты...
app.get('/', (req, res) => res.send('Home'));

// 5. Middleware для обработки ошибок - ВСЕГДА ПОСЛЕДНИМ!
app.use((err, req, res, next) => { // Обрати внимание на 4 аргумента!
  console.error("Global Error Handler:", err.stack || err.message);
  res.status(err.status || 500).json({
    error: err.message || 'Internal Server Error'
  });
});

app.listen(3005, () => console.log('Server with middleware listening on port 3005'));
```

**Критический взгляд**: Неправильный порядок middleware — одна из самых частых причин багов в Express-приложениях ("почему req.body пустой?", "почему аутентификация не срабатывает?"). Всегда внимательно следите за порядком `app.use()`.

## 5. Функция next() – Передача Эстафеты

- **next() без аргументов**: Передает управление следующей функции middleware или обработчику маршрута в цепочке.
- **next(err) с аргументом** (обычно объект Error): Сигнализирует об ошибке. Express пропустит все остальные обычные middleware и будет искать ближайший обработчик ошибок (см. ниже).

## 6. Middleware для Обработки Ошибок – Особый Вид

- **Сигнатура**: Отличается от обычных middleware — имеет четыре аргумента: `(err, req, res, next)`. Первый аргумент — это ошибка, переданная через `next(err)` или выброшенная синхронно в предыдущем обработчике/middleware (для async см. ниже).
- **Регистрация**: ОБЯЗАТЕЛЬНО регистрируется с помощью `app.use()` ПОСЛЕ всех остальных `app.use()` и обработчиков маршрутов.
- **Назначение**: Централизованно ловить ошибки, логировать их и отправлять пользователю стандартизированный ответ об ошибке (например, JSON с сообщением и статус-кодом 500).

**Критический взгляд**: Наличие хотя бы одного такого обработчика критически важно для любого production-приложения, чтобы оно не падало при первой же ошибке и не отправляло пользователю непонятные HTML-страницы с трейсом ошибок.

## 7. Встроенные и Сторонние Middleware

### Встроенные
Express предоставляет несколько базовых:
- **express.json()**: Парсит тело запроса с Content-Type: application/json. Добавляет результат в req.body.
- **express.urlencoded(\{ extended: false \})**: Парсит тело запроса с Content-Type: application/x-www-form-urlencoded. Добавляет результат в req.body.
- **express.static('public')**: Отдает статические файлы (HTML, CSS, JS, картинки) из указанной папки (public).

### Сторонние
Огромное количество middleware доступно через NPM для любых задач:
- **cors** (Cross-Origin Resource Sharing)
- **helmet** (безопасность заголовков)
- **morgan** (логирование запросов)
- **express-session** (сессии)
- **passport** (аутентификация)
и многие другие.

## Итог

Middleware — это фундаментальная концепция и главный инструмент расширения функциональности Express-приложений. Они позволяют строить гибкие конвейеры обработки запросов, добавляя логирование, парсинг, аутентификацию, валидацию и многое другое модульным образом.

Понимание потока выполнения (`next()`), важности порядка и механизма обработки ошибок (`next(err)` и error-handling middleware) абсолютно необходимо для эффективной работы с Express.
